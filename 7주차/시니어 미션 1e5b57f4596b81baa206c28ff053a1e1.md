# 시니어 미션

**미션 목표:**

- **500 에러**가 날 시 **자동**으로 **디스코드(or 슬랙)**에 올려보기

**미션 진행 과정 정리:**

1️⃣ **디스코드/슬랙 웹훅(Webhook) 설정**

- 디스코드 혹은 슬랙에서 **Webhook URL 생성**.

2️⃣ **예외 핸들러를 통해 500 에러 감지**

- `@ControllerAdvice` 500에러를 탐지하는 곳에 discord나 슬랙에 보내는 코드를 작성
- 발생한 예외 메시지, 요청 URL, 발생 시각 등의 정보를 포함한 **에러 로그 포맷 정의**.
- **디스코드**나 **슬랙**에 **POST 요청**을 보내는 **코드 작성** (이때 Webhook URL이 유출되지 않게금 주의한다.)

3️⃣ **에러 발생 시 알림 테스트**

- 강제로 500 에러를 발생시키는 API 엔드포인트를 구현하고 **정상적으로 알림이 전송되는지 테스트**.

4️⃣ **개발 서버, 로컬 서버** 알림 분리

- **개발 서버(or 운영 서버) 환경**에서만 알림이 오도록 **설정**
    - 만약 로컬 서버에서 난 에러도 알림이 가게 한다면 팀 협업 시 어떠한 일이 일어날 지 생각 해본다.

- 환경 분리

```java
@Bean
  @Profile({"local"})
  public WebhookEnabledMarker webhookEnabledMarker() {
    logger.info("local environment : webbhook alarm activated");
    return new WebhookEnabledMarker(true);
  }

  @Bean
  @Profile({"dev", "prod", "default"})
  public WebhookEnabledMarker webhookDisabledMarker() {
    logger.info("dev/deploy environment : webhook alarm deactivated");
    return new WebhookEnabledMarker(false);
  }
```

- 예외 핸들러

```java

    // 디스코드로 에러 알림 전송 (DiscordWebhookService에서 프로필 체크)
    discordWebHookService.sendErrorNotification(ex.getMessage(), requestUrl, stackTrace);
```

- 로컬 환경에서 알림

```java
if (!"local".equals(activeProfile)) {
      logger.info("현재 프로파일이 {}이므로 알림을 발송하지 않습니다.", activeProfile);
      return;
    }

    logger.info("Profile local -> send alaram");
```

- 실제 동작
    
    ![스크린샷 2025-05-14 오후 2.46.07.png](%E1%84%89%E1%85%B5%E1%84%82%E1%85%B5%E1%84%8B%E1%85%A5%20%E1%84%86%E1%85%B5%E1%84%89%E1%85%A7%E1%86%AB%201e5b57f4596b81baa206c28ff053a1e1/%E1%84%89%E1%85%B3%E1%84%8F%E1%85%B3%E1%84%85%E1%85%B5%E1%86%AB%E1%84%89%E1%85%A3%E1%86%BA_2025-05-14_%E1%84%8B%E1%85%A9%E1%84%92%E1%85%AE_2.46.07.png)