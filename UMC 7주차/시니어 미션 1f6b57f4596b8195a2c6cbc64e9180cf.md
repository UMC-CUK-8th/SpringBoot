# 시니어 미션

**미션 목표:**

- **500 에러**가 날 시 **자동**으로 **디스코드(or 슬랙)**에 올려보기

**미션 진행 과정 정리:**

1️⃣ **디스코드/슬랙 웹훅(Webhook) 설정**

- 디스코드 혹은 슬랙에서 **Webhook URL 생성**.

2️⃣ **예외 핸들러를 통해 500 에러 감지**

- `@ControllerAdvice` 500에러를 탐지하는 곳에 discord나 슬랙에 보내는 코드를 작성
- 발생한 예외 메시지, 요청 URL, 발생 시각 등의 정보를 포함한 **에러 로그 포맷 정의**.
- **디스코드**나 **슬랙**에 **POST 요청**을 보내는 **코드 작성** (이때 Webhook URL이 유출되지 않게금 주의한다.)

3️⃣ **에러 발생 시 알림 테스트**

- 강제로 500 에러를 발생시키는 API 엔드포인트를 구현하고 **정상적으로 알림이 전송되는지 테스트**.

4️⃣ **개발 서버, 로컬 서버** 알림 분리

- **개발 서버(or 운영 서버) 환경**에서만 알림이 오도록 **설정**
    - 만약 로컬 서버에서 난 에러도 알림이 가게 한다면 팀 협업 시 어떠한 일이 일어날 지 생각 해본다.

-웹훅 생성

```yaml
# application-prod.yml (운영 환경만 알림 발송)
error:
  notify:
    webhook-url: ${Webhook_Url}

```

-디스코드 전송 코드

```java
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

@Slf4j
@Component
@RequiredArgsConstructor
public class DiscordNotifier {

    @Value("${error.notify.webhook-url}")
    private String webhookUrl;

    private final RestTemplate restTemplate = new RestTemplate();

    public void sendErrorNotification(Exception e, String requestUri) {
        try {
            String message = """
                    🚨 **500 Error 발생**
                    📍 URL: %s
                    🕒 시간: %s
                    🧾 예외: `%s`
                    """.formatted(requestUri, LocalDateTime.now(), e.getMessage());

            Map<String, String> payload = new HashMap<>();
            payload.put("content", message);

            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);

            HttpEntity<Map<String, String>> entity = new HttpEntity<>(payload, headers);
            restTemplate.postForEntity(webhookUrl, entity, String.class);

        } catch (Exception ex) {
            log.error("디스코드 알림 전송 실패", ex);
        }
    }
}

```

-예외 핸들러

```java
@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    private final DiscordNotifier discordNotifier;
    private final String activeProfile;

    public GlobalExceptionHandler(DiscordNotifier discordNotifier,
                                   @Value("${spring.profiles.active:default}") String activeProfile) {
        this.discordNotifier = discordNotifier;
        this.activeProfile = activeProfile;
    }

    @ExceptionHandler(CustomException.class)
    public ResponseEntity<ErrorResponse> handleCustomException(CustomException e) {
        ErrorResponse response = ErrorResponse.builder()
                .errorCode(e.getErrorCode())
                .message(e.getMessage())
                .build();

        log.warn("{}", e.getMessage());
        return ResponseEntity.status(e.getStatus()).body(response);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleException(Exception e, HttpServletRequest request) {
        ErrorResponse response = ErrorResponse.builder()
                .errorCode(BaseErrorCode.INTERNAL_SERVER_ERROR)
                .message(BaseErrorCode.INTERNAL_SERVER_ERROR.getMessage())
                .build();

        log.error("Exception is occurred.", e);

        // 운영 환경일 때만 디스코드 알림
        if ("prod".equals(activeProfile)) {
            discordNotifier.sendErrorNotification(e, request.getRequestURI());
        }

        return ResponseEntity.status(response.getErrorCode().getStatus()).body(response);
    }
}

```

-테스트 api

```java
@RestController
@RequestMapping("api/test")
public class TestController {

    @GetMapping("/error")
    public void throwError() {
        throw new RuntimeException("500 에러 발생");
    }
}

```

-로컬 서버 에러가 알림이 간다면?

반복된 테스트 과정에서 오류가 계속 발생할텐데 쓸모없는 알림 폭탄 가능.

운영/개발 환경 에러 구분이 어려워질 수 있음

 로컬 테스트 중 에러나 데이터가 전송되면 의도치 않은 내부 정보 유출 가능